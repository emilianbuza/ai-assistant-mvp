<!-- public/index.html -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Inbox Assistant</title>
  <style>
    :root{
      --bg:#f4f6f9;--card:#ffffff;--text:#0f172a;--muted:#64748b;--brand:#1e3a8a;--brand2:#2563eb;
      --b:#e5e7eb;--ok:#16a34a;--warn:#f59e0b;--danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0}
    header{background:var(--brand);color:#fff;padding:18px 28px;display:flex;gap:16px;align-items:center;justify-content:space-between}
    header .t{font-weight:700;font-size:18px}
    header .s{opacity:.8;font-size:12px}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
    .card{background:var(--card);border:1px solid var(--b);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--b);font-size:16px}
    .card .content{padding:14px 16px}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 10px;font-size:12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .btn{background:var(--brand2);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer;transition:.2s}
    .btn:hover{background:var(--brand)}
    .btn.ghost{background:#eef2ff;color:#3730a3}
    .btn.flat{background:#f1f5f9;color:#0f172a}
    textarea{width:100%;min-height:130px;border:1px solid var(--b);border-radius:10px;padding:12px;font-size:14px;resize:vertical}
    input[type=file]{display:block;margin-top:10px}
    .list{display:grid;gap:10px}
    .mail{background:#f8fafc;border:1px solid var(--b);border-radius:10px;padding:10px 12px;font-size:14px}
    .mail strong{color:var(--brand)}
    .loading{display:none;color:var(--muted);font-style:italic;margin-top:8px}
    .loading.show{display:block}
    /* Tasks */
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--b);background:#f8fafc;color:#0f172a;border-radius:999px;padding:6px 12px;font-size:13px;cursor:pointer}
    .tab.active{background:#111827;color:#fff;border-color:#111827}
    .tasks{display:grid;gap:10px;margin-top:12px}
    .task{border:1px solid var(--b);border-radius:12px;background:#fff;padding:12px;position:relative;overflow:hidden;transition:transform .15s ease,opacity .2s ease}
    .task.removing{opacity:0;transform:translateY(6px)}
    .task h4{margin:0 0 6px 0;font-size:15px}
    .badge{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}
    .p1{background:#fee2e2;color:#991b1b}
    .p2{background:#ffedd5;color:#9a3412}
    .p3{background:#dcfce7;color:#166534}
    .time{background:#e0e7ff;color:#3730a3}
    .due{background:#fef9c3;color:#854d0e}
    .muted{color:var(--muted);font-size:13px}
    .task .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .task .actions .done{background:#22c55e}
    .task .actions .done:hover{background:#16a34a}
    .task details{margin-top:8px}
    .statbar{display:flex;gap:12px;flex-wrap:wrap}
    .stat{background:#f1f5f9;border:1px solid var(--b);border-radius:10px;padding:8px 10px;font-size:13px}
    .trust{margin-top:10px;color:var(--muted);font-size:12px}
    .hr{height:1px;background:var(--b);margin:12px 0}
    .toprow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .hide{display:none}
  </style>
</head>
<body>
  <header>
    <div class="t">AI Inbox Assistant</div>
    <div class="row">
      <div class="pill" id="savedCounter">‚è≥ Zeitersparnis heute: 0 Min</div>
      <div class="s">lokaler Demo-Build</div>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- Quellen / Links -->
      <section class="card">
        <h3>üì© Quellen</h3>
        <div class="content">
          <div class="row">
            <button class="btn" id="fetchMails">Gmail (Demo) abrufen</button>
            <button class="btn flat" id="clearMails">Liste leeren</button>
          </div>
          <div class="loading" id="loading">Die KI denkt nach‚Ä¶</div>
          <div class="hr"></div>
          <div class="list" id="mailList"></div>
        </div>
      </section>

      <!-- Eigenen Input -->
      <section class="card">
        <h3>‚ûï Eigenen Text/Datei analysieren</h3>
        <div class="content">
          <form id="textForm">
            <textarea id="textInput" placeholder="Text oder E-Mail-Inhalt hier einf√ºgen‚Ä¶"></textarea>
            <div class="row" style="margin-top:10px">
              <button class="btn" type="submit">Analysieren</button>
              <button class="btn flat" type="button" id="clearText">Feld leeren</button>
            </div>
          </form>
          <div class="hr"></div>
          <form id="fileForm">
            <input type="file" id="fileInput"/>
            <div class="row" style="margin-top:10px">
              <button class="btn" type="submit">Datei hochladen & analysieren</button>
            </div>
          </form>
          <div class="trust">Alles bleibt lokal in dieser Sitzung. Es werden nur Inhalte analysiert, die du hier explizit einreichst.</div>
        </div>
      </section>
    </div>

    <!-- Aufgabenbereich -->
    <section class="card" style="margin-top:18px">
      <h3>üéØ Aufgaben</h3>
      <div class="content">
        <div class="toprow">
          <div class="tabs">
            <button class="tab active" data-tab="all">Alle</button>
            <button class="tab" data-tab="1">Dringend</button>
            <button class="tab" data-tab="2">Wichtig (48h)</button>
            <button class="tab" data-tab="3">Sp√§ter</button>
          </div>
          <div class="statbar">
            <div class="stat" id="countStat">0 Aufgaben</div>
            <div class="stat" id="etaStat">~ 0 Min Aufwand</div>
            <button class="btn ghost" id="showTop3">Nur Top 3</button>
            <button class="btn flat" id="resetDone">Erledigte zur√ºckholen</button>
          </div>
        </div>

        <div class="tasks" id="taskContainer"></div>
      </div>
    </section>
  </main>

  <script>
    // --- State ---
    const fetchBtn = document.getElementById("fetchMails");
    const clearMailsBtn = document.getElementById("clearMails");
    const mailList = document.getElementById("mailList");
    const loading = document.getElementById("loading");
    const textForm = document.getElementById("textForm");
    const fileForm = document.getElementById("fileForm");
    const textInput = document.getElementById("textInput");
    const clearTextBtn = document.getElementById("clearText");
    const taskContainer = document.getElementById("taskContainer");
    const tabs = Array.from(document.querySelectorAll(".tab"));
    const countStat = document.getElementById("countStat");
    const etaStat = document.getElementById("etaStat");
    const savedCounter = document.getElementById("savedCounter");
    const showTop3Btn = document.getElementById("showTop3");
    const resetDoneBtn = document.getElementById("resetDone");

    let currentMails = [];
    let allTasks = [];
    let activeTab = "all";
    let showTop3 = false;

    // --- Helpers ---
    const LS_KEY = "aii_tasks_v1";
    const LS_DONE = "aii_tasks_done_v1";
    const LS_SAVED_MIN = "aii_time_saved_today";

    function showLoading(s){ loading.classList.toggle("show", !!(s)); }

    function priBadge(p){
      if(p===1) return '<span class="badge p1">Dringend</span>';
      if(p===2) return '<span class="badge p2">Wichtig (48h)</span>';
      return '<span class="badge p3">Sp√§ter</span>';
    }

    function hashTask(t){ return btoa(unescape(encodeURIComponent(`${t.title}|${t.due||""}|${t.priority}`))).slice(0,24); }

    function getDoneSet(){
      const raw = localStorage.getItem(LS_DONE);
      return new Set(raw ? JSON.parse(raw) : []);
    }
    function setDoneSet(set){
      localStorage.setItem(LS_DONE, JSON.stringify(Array.from(set)));
    }

    function addSavedMinutes(min){
      const curr = Number(localStorage.getItem(LS_SAVED_MIN) || 0);
      const next = curr + (Number(min)||0);
      localStorage.setItem(LS_SAVED_MIN, String(next));
      savedCounter.textContent = `‚è≥ Zeitersparnis heute: ${next} Min`;
    }

    function setSavedMinutes(min){
      localStorage.setItem(LS_SAVED_MIN, String(min));
      savedCounter.textContent = `‚è≥ Zeitersparnis heute: ${min} Min`;
    }

    function persistTasks(tasks){
      localStorage.setItem(LS_KEY, JSON.stringify(tasks));
    }

    function loadTasks(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        allTasks = raw ? JSON.parse(raw) : [];
      }catch{ allTasks = []; }
      updateStats();
      renderTasks();
    }

    function updateStats(){
      const done = getDoneSet();
      const pending = allTasks.filter(t => !done.has(hashTask(t)));
      const minutes = pending.reduce((a,b)=>a+(Number(b.effort_minutes)||0),0);
      countStat.textContent = `${pending.length} Aufgaben`;
      etaStat.textContent = `~ ${minutes} Min Aufwand`;
      const saved = Number(localStorage.getItem(LS_SAVED_MIN)||0);
      savedCounter.textContent = `‚è≥ Zeitersparnis heute: ${saved} Min`;
    }

    // --- Rendering ---
    function renderMails(){
      mailList.innerHTML = currentMails.length
        ? currentMails.map(m => `<div class="mail"><strong>${m.from}</strong><br>${m.subject}<br><small>${m.snippet}</small></div>`).join("")
        : "<div class='muted'>Noch keine E-Mails geladen.</div>";
    }

    function renderTasks(){
      const done = getDoneSet();
      let items = allTasks.filter(t => !done.has(hashTask(t)));
      if(activeTab !== "all") items = items.filter(t => String(t.priority) === String(activeTab));
      items.sort((a,b)=> a.priority-b.priority || (a.due?1:0)-(b.due?1:0) || a.effort_minutes-b.effort_minutes);
      if(showTop3) items = items.slice(0,3);

      taskContainer.innerHTML = items.map(t => `
        <div class="task" data-id="${hashTask(t)}">
          <h4>${t.title}</h4>
          ${priBadge(Number(t.priority))}
          <span class="badge time">~ ${t.effort_minutes||30} min</span>
          ${t.due ? `<span class="badge due">F√§llig: ${t.due}</span>` : ""}
          ${t.suggested_timebox ? `<div class="muted" style="margin-top:6px">‚è±Ô∏è Vorschlag: ${t.suggested_timebox}</div>` : ""}
          <div class="muted" style="margin-top:6px">Warum: ${t.reason || "‚Äî"}</div>
          ${Array.isArray(t.steps) && t.steps.length ? `
            <details style="margin-top:8px">
              <summary>Schritt-f√ºr-Schritt anzeigen</summary>
              <ol style="margin:6px 0 0 20px">
                ${t.steps.map(s=>`<li>${s}</li>`).join("")}
              </ol>
            </details>
          ` : ""}
          <div class="actions">
            <button class="btn done">Erledigt</button>
            <button class="btn flat plan">In Kalender planen (kopieren)</button>
          </div>
        </div>
      `).join("");

      // bind actions
      taskContainer.querySelectorAll(".task .done").forEach(btn=>{
        btn.addEventListener("click", e=>{
          const el = e.target.closest(".task");
          const id = el.getAttribute("data-id");
          const set = getDoneSet(); set.add(id); setDoneSet(set);
          addSavedMinutes(5); // Reward-Mikro: 5 Min angenommen
          el.classList.add("removing");
          setTimeout(()=>{ el.remove(); updateStats(); },150);
        });
      });
      taskContainer.querySelectorAll(".task .plan").forEach(btn=>{
        btn.addEventListener("click", e=>{
          const el = e.target.closest(".task");
          const id = el.getAttribute("data-id");
          const t = allTasks.find(x=>hashTask(x)===id);
          const txt = `${t.title}\nWarum: ${t.reason}\nDauer: ~${t.effort_minutes} Min\nSlot: ${t.suggested_timebox||"Vorschlag frei w√§hlen"}`;
          navigator.clipboard.writeText(txt);
          btn.textContent = "Details kopiert ‚úì";
          setTimeout(()=>btn.textContent = "In Kalender planen (kopieren)",1500);
        });
      });

      updateStats();
    }

    // --- AI bridge ---
    async function analyzeMessages(messagesArray){
      showLoading(true);
      try{
        const res = await fetch("/inbox/text",{
          method:"POST",
          headers:{ "Content-Type":"application/x-www-form-urlencoded" },
          body:"text="+encodeURIComponent(JSON.stringify(messagesArray))
        });
        const data = await res.json();
        showLoading(false);
        if(!data.ok){ alert("Analyse-Fehler: "+data.error); return; }
        // Persist + render
        allTasks = data.tasks || [];
        persistTasks(allTasks);
        // Heuristische ‚ÄûZeitersparnis‚Äú: Summe Aufwand * 0.3 (als Orientierung)
        const saved = Math.round((allTasks.reduce((a,b)=>a+(Number(b.effort_minutes)||0),0)) * 0.3);
        setSavedMinutes(saved);
        renderTasks();
      }catch(err){
        showLoading(false);
        alert("Netzwerkfehler: "+err.message);
      }
    }

    // --- Events: Tabs, Buttons, Forms ---
    tabs.forEach(t=>{
      t.addEventListener("click", ()=>{
        tabs.forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        activeTab = t.dataset.tab;
        renderTasks();
      });
    });

    showTop3Btn.addEventListener("click", ()=>{
      showTop3 = !showTop3;
      showTop3Btn.textContent = showTop3 ? "Alle anzeigen" : "Nur Top 3";
      renderTasks();
    });

    resetDoneBtn.addEventListener("click", ()=>{
      setDoneSet(new Set());
      updateStats();
      renderTasks();
    });

    clearMailsBtn.addEventListener("click", ()=>{
      currentMails = [];
      renderMails();
    });

    fetchBtn.addEventListener("click", async ()=>{
      showLoading(true);
      const res = await fetch("/fetch");
      const data = await res.json();
      showLoading(false);
      if(!data.ok){ alert("Fehler beim Laden"); return; }
      currentMails = data.gmail || [];
      renderMails();
      if(currentMails.length){
        const msgs = currentMails.map(m=>({ source:"Gmail", subject:m.subject, text:m.snippet, from:m.from }));
        analyzeMessages(msgs);
      }
    });

    textForm.addEventListener("submit", e=>{
      e.preventDefault();
      const text = textInput.value.trim();
      if(!text){ alert("Bitte Text eingeben"); return; }
      analyzeMessages([{ source:"Inbox", subject:"Benutzertext", text }]);
    });

    clearTextBtn.addEventListener("click", ()=>{ textInput.value=""; });

    fileForm.addEventListener("submit", async e=>{
      e.preventDefault();
      const file = document.getElementById("fileInput").files[0];
      if(!file){ alert("Bitte eine Datei ausw√§hlen"); return; }
      showLoading(true);
      const fd = new FormData(); fd.append("file", file);
      const res = await fetch("/inbox/upload",{ method:"POST", body:fd });
      const data = await res.json();
      showLoading(false);
      if(!data.ok){ alert("Fehler: "+data.error); return; }
      allTasks = data.tasks || [];
      persistTasks(allTasks);
      const saved = Math.round((allTasks.reduce((a,b)=>a+(Number(b.effort_minutes)||0),0)) * 0.3);
      setSavedMinutes(saved);
      renderTasks();
    });

    // --- Init ---
    loadTasks();
  </script>
</body>
</html>
